<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário Dinâmico</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos CSS permanecem os mesmos do arquivo original */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100% ); color: #333; line-height: 1.6; min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center; }
        .container { max-width: 800px; width: 100%; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); overflow: hidden; }
        .form-header { background: linear-gradient(135deg, #3a7bd5, #00d2ff); color: white; padding: 25px; text-align: center; }
        .form-title { font-size: 28px; margin-bottom: 8px; font-weight: 700; }
        .form-description { font-size: 16px; opacity: 0.9; }
        .loading-container { padding: 40px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dynamic-form { padding: 25px; }
        .form-group { margin-bottom: 20px; padding: 15px; border-radius: 10px; background: #f8f9fa; border-left: 4px solid #3a7bd5; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; transition: border-color 0.3s; }
        .form-control:focus { outline: none; border-color: #3a7bd5; box-shadow: 0 0 0 3px rgba(58, 123, 213, 0.2); }
        .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 10px; }
        .radio-option, .checkbox-option { display: flex; align-items: center; gap: 10px; }
        .form-actions { text-align: center; margin-top: 30px; padding: 20px; }
        .submit-btn { background: linear-gradient(135deg, #3a7bd5, #00d2ff); color: white; border: none; padding: 14px 30px; font-size: 18px; border-radius: 50px; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3); }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 210, 255, 0.4); }
        .submit-btn:active { transform: translateY(0); }
        .success-message, .error-message { text-align: center; padding: 40px; }
        .success-icon, .error-icon { font-size: 60px; margin-bottom: 20px; }
        .success-icon { color: #28a745; }
        .error-icon { color: #dc3545; }
        .success-message h2, .error-message h2 { margin-bottom: 15px; color: #2c3e50; }
        .retry-btn { background: #3a7bd5; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; margin-top: 20px; font-size: 16px; transition: background 0.3s; }
        .retry-btn:hover { background: #2c5fa1; }
        .required-field::after { content: " *"; color: #dc3545; }
        .info-text { font-size: 14px; color: #6c757d; margin-top: 5px; }
        /* Estilo para ocultar perguntas */
        .hidden-question { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-header">
            <h1 class="form-title">Formulário Dinâmico</h1>
            <p class="form-description">Preencha as informações solicitadas abaixo</p>
        </div>

        <div class="loading-container" id="loadingContainer">
            <div class="loading-spinner"></div>
            <p>Carregando formulário...</p>
        </div>

        <form id="dynamicForm" class="dynamic-form" style="display: none;">
            <div id="questionsContainer" class="questions-container"></div>
            <div class="form-actions">
                <button type="submit" class="submit-btn" id="submitBtn">
                    <i class="fas fa-paper-plane"></i>
                    Enviar Respostas
                </button>
            </div>
        </form>

        <div class="success-message" id="successMessage" style="display: none;">
            <div class="success-icon"><i class="fas fa-check-circle"></i></div>
            <h2>Respostas enviadas com sucesso!</h2>
            <p>Obrigado por participar. Suas respostas foram registradas.</p>
        </div>

        <div class="error-message" id="errorMessage" style="display: none;">
            <div class="error-icon"><i class="fas fa-exclamation-circle"></i></div>
            <h2>Erro ao enviar respostas</h2>
            <p id="errorText">Ocorreu um erro inesperado. Tente novamente.</p>
            <button class="retry-btn" onclick="location.reload()">Tentar Novamente</button>
        </div>
    </div>

    <script>
        // URL do Google Apps Script - SUBSTITUA pela sua URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzq789ichA-ODURHYaORVZdBV-n2TvS09hOfqtfL8aAK_XC8Lr_nOCB7h22RhAlbhdA/exec'; // ATUALIZE ESTA URL!

        // Elementos do DOM
        const loadingContainer = document.getElementById('loadingContainer' );
        const dynamicForm = document.getElementById('dynamicForm');
        const questionsContainer = document.getElementById('questionsContainer');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const submitBtn = document.getElementById('submitBtn');

        let perguntas = [];
        let configuracoes = [];
        let restricoesVisibilidade = []; // *** NOVO ***: Para armazenar as restrições de visibilidade
        let perguntasMap = new Map(); // *** NOVO ***: Para mapear perguntas por ID

        document.addEventListener('DOMContentLoaded', carregarFormulario);

        async function carregarFormulario() {
            try {
                const [perguntasResponse, configuracoesResponse, restricoesResponse] = await Promise.all([
                    fetch(`${SCRIPT_URL}?action=getPerguntas`),
                    fetch(`${SCRIPT_URL}?action=getConfiguracoes`),
                    fetch(`${SCRIPT_URL}?action=getRestricoesVisibilidade`) // *** NOVO ***: Busca as restrições
                ]);

                if (!perguntasResponse.ok || !configuracoesResponse.ok || !restricoesResponse.ok) {
                    throw new Error('Falha ao buscar dados do servidor.');
                }

                const perguntasData = await perguntasResponse.json();
                const configuracoesData = await configuracoesResponse.json();
                const restricoesData = await restricoesResponse.json(); // *** NOVO ***: Processa as restrições

                if (!perguntasData.success || !configuracoesData.success || !restricoesData.success) {
                    throw new Error(perguntasData.error || configuracoesData.error || restricoesData.error || 'Dados do formulário inválidos.');
                }

                perguntas = perguntasData.perguntas;
                configuracoes = configuracoesData.configuracoes;
                restricoesVisibilidade = restricoesData.restricoes; // *** NOVO ***: Armazena as restrições

                // *** NOVO ***: Cria um mapa de perguntas para fácil acesso
                perguntas.forEach(p => perguntasMap.set(p.ID, p));

                renderizarPerguntas();
                adicionarListenersVisibilidade(); // *** NOVO ***: Adiciona listeners para visibilidade
                
                loadingContainer.style.display = 'none';
                dynamicForm.style.display = 'block';
            } catch (error) {
                console.error('Erro ao carregar formulário:', error);
                loadingContainer.innerHTML = `
                    <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <h3>Erro ao carregar formulário</h3>
                    <p>${error.message || 'Verifique sua conexão e tente novamente.'}</p>
                    <button class="retry-btn" onclick="location.reload()">Recarregar</button>
                `;
            }
        }

        function renderizarPerguntas() {
            questionsContainer.innerHTML = '';
            perguntas.forEach(pergunta => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                formGroup.id = `group-${pergunta.ID}`; // *** NOVO ***: Adiciona um ID ao grupo da pergunta
                
                const label = document.createElement('label');
                label.htmlFor = pergunta.ID;
                label.innerHTML = pergunta['Texto da Pergunta'];
                if (pergunta.Obrigatoria === 'Sim') label.classList.add('required-field');
                formGroup.appendChild(label);
                
                switch (pergunta.Tipo) {
                    case 'Texto':
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.id = pergunta.ID;
                        input.name = pergunta.ID;
                        input.className = 'form-control';
                        if (pergunta.Obrigatoria === 'Sim') input.required = true;
                        formGroup.appendChild(input);
                        break;
                    case 'Dropdown':
                        const select = document.createElement('select');
                        select.id = pergunta.ID;
                        select.name = pergunta.ID;
                        select.className = 'form-control';
                        if (pergunta.Obrigatoria === 'Sim') select.required = true;
                        select.innerHTML = '<option value="">Selecione uma opção</option>';
                        if (pergunta.Opcoes) {
                            pergunta.Opcoes.split(',').forEach(opcao => {
                                const option = document.createElement('option');
                                option.value = opcao.trim();
                                option.textContent = opcao.trim();
                                select.appendChild(option);
                            });
                        }
                        formGroup.appendChild(select);
                        break;
                    case 'Radio':
                        const radioGroup = document.createElement('div');
                        radioGroup.className = 'radio-group';
                        if (pergunta.Opcoes) {
                            pergunta.Opcoes.split(',').forEach(opcao => {
                                const optionDiv = document.createElement('div');
                                optionDiv.className = 'radio-option';
                                const radio = document.createElement('input');
                                radio.type = 'radio';
                                radio.id = `${pergunta.ID}_${opcao.trim()}`;
                                radio.name = pergunta.ID;
                                radio.value = opcao.trim();
                                if (pergunta.Obrigatoria === 'Sim') radio.required = true;
                                const radioLabel = document.createElement('label');
                                radioLabel.htmlFor = radio.id;
                                radioLabel.textContent = opcao.trim();
                                optionDiv.append(radio, radioLabel);
                                radioGroup.appendChild(optionDiv);
                            });
                        }
                        formGroup.appendChild(radioGroup);
                        break;
                    case 'Checkbox':
                        const checkboxGroup = document.createElement('div');
                        checkboxGroup.className = 'checkbox-group';
                        if (pergunta.Opcoes) {
                            pergunta.Opcoes.split(',').forEach(opcao => {
                                const optionDiv = document.createElement('div');
                                optionDiv.className = 'checkbox-option';
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.id = `${pergunta.ID}_${opcao.trim()}`;
                                checkbox.name = pergunta.ID;
                                checkbox.value = opcao.trim();
                                const checkboxLabel = document.createElement('label');
                                checkboxLabel.htmlFor = checkbox.id;
                                checkboxLabel.textContent = opcao.trim();
                                optionDiv.append(checkbox, checkboxLabel);
                                checkboxGroup.appendChild(optionDiv);
                            });
                        }
                        formGroup.appendChild(checkboxGroup);
                        break;
                }
                
                if (pergunta.Obrigatoria === 'Sim') {
                    const infoText = document.createElement('p');
                    infoText.className = 'info-text';
                    infoText.textContent = 'Este campo é obrigatório';
                    formGroup.appendChild(infoText);
                }
                questionsContainer.appendChild(formGroup);
            });
        }

        // *** NOVO ***: Adiciona listeners para aplicar restrições de visibilidade
        function adicionarListenersVisibilidade() {
            const turmaSelect = document.getElementById('P1'); // Assumindo que P1 é a pergunta da turma
            if (turmaSelect) {
                turmaSelect.addEventListener('change', aplicarRestricoesVisibilidade);
                // Aplica as restrições na carga inicial, caso já haja uma turma selecionada
                aplicarRestricoesVisibilidade(); 
            }
        }

        // *** NOVO ***: Função para aplicar as restrições de visibilidade
        function aplicarRestricoesVisibilidade() {
            const turmaSelecionada = document.getElementById('P1')?.value; // Pega o valor da turma selecionada

            perguntas.forEach(pergunta => {
                const perguntaGroup = document.getElementById(`group-${pergunta.ID}`);
                if (!perguntaGroup) return; // Se o grupo da pergunta não existe, pula

                // Verifica se existe uma restrição para esta pergunta e a turma selecionada
                const restricao = restricoesVisibilidade.find(r => 
                    r.Identificador === turmaSelecionada && 
                    r.Pergunta === pergunta['Texto da Pergunta']
                );

                if (restricao) {
                    perguntaGroup.classList.add('hidden-question');
                    // Se a pergunta for oculta, desmarca como obrigatória para evitar validação
                    const inputElement = document.getElementById(pergunta.ID) || document.querySelector(`[name="${pergunta.ID}"]`);
                    if (inputElement) {
                        inputElement.required = false;
                        // Limpa o valor do campo oculto para não enviar dados indesejados
                        if (inputElement.type === 'text' || inputElement.tagName === 'SELECT') {
                            inputElement.value = '';
                        } else if (inputElement.type === 'radio' || inputElement.type === 'checkbox') {
                            document.querySelectorAll(`[name="${pergunta.ID}"]`).forEach(el => el.checked = false);
                        }
                    }
                } else {
                    perguntaGroup.classList.remove('hidden-question');
                    // Se a pergunta não for oculta, restaura a obrigatoriedade se ela for originalmente obrigatória
                    const originalPergunta = perguntasMap.get(pergunta.ID); // Pega a pergunta original do mapa
                    if (originalPergunta && originalPergunta.Obrigatoria === 'Sim') {
                        const inputElement = document.getElementById(pergunta.ID) || document.querySelector(`[name="${pergunta.ID}"]`);
                        if (inputElement) {
                            inputElement.required = true;
                        }
                    }
                }
            });
        }

        dynamicForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(dynamicForm);
            const respostas = {};
            for (const [key, value] of formData.entries()) {
                // *** NOVO ***: Ignora campos de perguntas ocultas
                const perguntaGroup = document.getElementById(`group-${key}`);
                if (perguntaGroup && perguntaGroup.classList.contains('hidden-question')) {
                    continue; 
                }

                if (respostas[key]) {
                    respostas[key] = `${respostas[key]}, ${value}`;
                } else {
                    respostas[key] = value;
                }
            }
            
            let formularioValido = true;
            perguntas.forEach(pergunta => {
                const perguntaGroup = document.getElementById(`group-${pergunta.ID}`);
                // *** NOVO ***: Apenas valida perguntas visíveis e obrigatórias
                if (pergunta.Obrigatoria === 'Sim' && !perguntaGroup.classList.contains('hidden-question') && !respostas[pergunta.ID]) {
                    formularioValido = false;
                    const element = document.getElementById(pergunta.ID) || document.querySelector(`[name="${pergunta.ID}"]`);
                    if (element) {
                        const formGroup = element.closest('.form-group');
                        if (formGroup) formGroup.style.borderColor = '#dc3545';
                    }
                }
            });
            
            if (!formularioValido) {
                alert('Por favor, preencha todos os campos obrigatórios visíveis.');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=submitForm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({ respostas })
                });
                
                if (!response.ok) {
                    throw new Error(`Erro do servidor: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    dynamicForm.style.display = 'none';
                    successMessage.style.display = 'block';
                } else {
                    throw new Error(result.error || 'Ocorreu um erro ao processar sua resposta.');
                }
            } catch (error) {
                console.error('Erro ao enviar formulário:', error);
                errorText.textContent = error.message;
                errorMessage.style.display = 'block';
                dynamicForm.style.display = 'none';
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Respostas';
            }
        });
    </script>
</body>
</html>
